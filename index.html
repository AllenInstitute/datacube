<!DOCTYPE html>
<html>
<head>
</head>
<body>
<h3>pandas service demo page</h3>
<noscript>You must enable JavaScript</noscript>
<form>
    <div>filters:</div>
    <textarea id="filters" style="width: 80%;" rows="15">
[
    {
        "field": "p_sg",
        "op": "<=",
        "value": 0.01
    },
    {
        "field": "pref_phase_sg",
        "op": "=",
        "value": 0.25
    },
    {
        "field": "pref_sf_sg",
        "op": "=",
        "value": 0.02
    },
    {
        "field": "p_dg",
        "op": "<=",
        "value": 0.01
    },
    {
        "field": "pref_tf_dg",
        "op": "=",
        "value": 1
    },
    {
        "field": "dsi_dg",
        "op": "between",
        "value": [
            0.7,
            2
        ]
    },
    {
        "field": "time_to_peak_ns",
        "op": "between",
        "value": [
            0,
            0.18
        ]
    },
    {
        "field": "area",
        "op": "in",
        "value": [
            "VISp",
            "VISal",
            "VISl"
        ]
    }
]
</textarea>
</form>
<div><button onclick="apply_filters()">apply filters</button></div>
<p>Results: <span id="num_rows"></span></p>
<table style="width:87%;">
<tr>
<td>
<textarea id="records" style="width:98%;resize:none;" rows="20" wrap="off" disabled></textarea>
</td>
<td>
<div id="scrollbar" style="overflow:scroll;overflow:auto;height:20em;width:12px;">
<textarea id="scroller" rows="20" cols="1" disabled></textarea>
</div>
</td>
</tr>
</table>
<script type="text/javascript" src="./autobahn.min.js"></script>
<script type="text/javascript" src="./zlib.min.js"></script>
<script type="text/javascript" src="./pako.min.js"></script>
<script type="text/javascript" src="./encoding.js"></script>
<script type="text/javascript" src="./structured_array.js"></script>
<script type="text/javascript">


// poll for scroll events and prevent concurrent calls to update_page
var pending = false;
var did_scroll = false;
function scroll() {
    did_scroll = true;
}
setInterval(function() {
    if(did_scroll) {
        did_scroll = false;
        if(!pending) {
            pending = true;
            update_page();
        }
    }
}, 50);

function finished() {
    pending = false;
}

document.getElementById('scrollbar').onscroll = scroll;


function BrainObservatoryPandasService(url,
                                       realm,
                                       chunk_size,
                                       preload_margin,
                                       get_current_filters,
                                       apply_filters_callback,
                                       get_current_page_range,
                                       page_data_callback,
                                       finished_callback) {
    this.connection = new autobahn.Connection({
         url: url,
         realm: realm
    });

    var self = this;
    this.connection.onopen = function (s) {
        self.session = s;
        self.apply_filters();
    };

    this.chunk_size = chunk_size;
    this.preload_margin = preload_margin;

    this.get_current_filters = get_current_filters;
    this.apply_filters_callback = apply_filters_callback;
    this.get_current_page_range = get_current_page_range;
    this.page_data_callback = page_data_callback;
    this.finished_callback = finished_callback;

    this.previous_range = {"start": 0, "end": 0};
    this.records = [];

    this.connection.open();
};

BrainObservatoryPandasService.prototype.apply_filters = function() {
    filters = this.get_current_filters();
    var self = this;
    this.session.call('org.alleninstitute.pandas_service.filter_cell_specimens', [],
                      {'fields': 'indexes_only', 'filters': filters}).then(
        function (res) {
            self.indexes = res;
            self.previous_range = {"start": 0, "end": 0};
            self.records = [];
            self.apply_filters_callback(self.indexes.length);
            self.update_page();
        }
    );
            
};

BrainObservatoryPandasService.prototype.update_page = function() {
    var self = this;
    var page_range = this.get_current_page_range(this.indexes.length);

    function Range(start, end) {
        if(start <= end) {
            return {"start": Math.min(start, end), "end": Math.max(start, end)};
        } else {
            return {"start": start, "end": start};
        }
    };

    var preload_range = Range(Math.max(0, page_range.start - this.preload_margin),
                              Math.min(this.indexes.length , page_range.end + this.preload_margin));
    var range = Range(Math.max(0, page_range.start - this.chunk_size),
                      Math.min(this.indexes.length , page_range.end + this.chunk_size));
    var keep = Range(Math.max(range.start, Math.min(this.previous_range.start, range.end)),
                     Math.min(range.end, Math.max(this.previous_range.end, range.start)));
    var load_preceding = preload_range.start < this.previous_range.start
        ? Range(range.start, Math.min(this.previous_range.start, range.end))
        : Range(keep.start, keep.start);
    var load_following = preload_range.end > this.previous_range.end
        ? Range(Math.max(this.previous_range.end, range.start), range.end)
        : Range(keep.end, keep.end);


    var kept_records = this.records.slice(keep.start - this.previous_range.start,
                                          keep.end - this.previous_range.start);

    function load_records(range, callback) {
        if(range.end <= range.start) {
            callback([], range);
        } else {
            var indexes = self.indexes.slice(range.start, range.end);
            console.log('==> requesting ' + (range.end - range.start) + ' records from server: [' + range.start + ', ' + range.end + ')');
            self.session.call('org.alleninstitute.pandas_service.filter_cell_specimens', [],
                                 {'indexes': indexes}).then(
                function (res) {
                    var sa = new StructuredArray(res);
                    var records = sa.lazy_get_all();
                    callback(records, range);
                }
            );
        }
    };

    var updated = false;
    if(page_range.start >= this.previous_range.start && page_range.end <= this.previous_range.end) {
        setTimeout(function() {
            self.page_data_callback(self.records.slice(page_range.start - self.previous_range.start, page_range.end - self.previous_range.start));
        }, 0);
        updated = true;
    }

    load_records(load_preceding, function (preceding_records, preceding_range) {
        load_records(load_following, function (following_records, following_range) {
            self.records = preceding_records.concat(kept_records).concat(following_records);
            var result_range = Range(preceding_range.start, following_range.end);
            for(var record_idx = page_range.start - result_range.start;
                    record_idx < page_range.end - result_range.start;
                    ++record_idx) {
                if(typeof self.records[record_idx] === "function") {
                    self.records[record_idx] = self.records[record_idx]();
                }
            }
            if(!updated) {
                self.page_data_callback(self.records.slice(page_range.start - result_range.start, page_range.end - result_range.start));
            }
            console.log('records currently in memory: [' + result_range.start + ', ' + result_range.end + ')');
            self.previous_range = result_range;
            self.finished_callback();
        });
    });
};

function get_current_filters() {
    return JSON.parse(document.getElementById('filters').value);
};

function get_current_page_range(sz) {
    var scrollbar = document.getElementById('scrollbar');
    var start_idx = Math.round(scrollbar.scrollTop/scrollbar.scrollHeight * sz);
    var end_idx = start_idx + 20;
    return {"start": start_idx, "end": end_idx}
};

function process_num_results(sz) {
    document.getElementById.scrollTop = 0; // reset scroll
    document.getElementById('num_rows').innerHTML = sz;
    document.getElementById('scroller').rows = sz;
};

function process_page(records) {
    var txt = [];
    for(var i = 0; i < records.length; ++i) {
        txt.push(JSON.stringify(records[i]));
    }
    document.getElementById('records').innerHTML = txt.join('\n');
};

var service = new BrainObservatoryPandasService('ws://' + window.location.hostname + ':8081/ws',
                                                'pandas_service',
                                                100,
                                                25,
                                                get_current_filters,
                                                process_num_results,
                                                get_current_page_range,
                                                process_page,
                                                finished);


function apply_filters() {
    service.apply_filters();
};


function update_page() {
    service.update_page();
};

</script>
</body>
</html>
