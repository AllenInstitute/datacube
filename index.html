<!DOCTYPE html>
<html>
<head>
</head>
<body>
<h3>datacube test page</h3>
<noscript>You must enable JavaScript</noscript>
<canvas id="graph"  width="300" height="150"></canvas>
<form>
    <div>call:</div>
    <textarea id="call" cols="80">org.alleninstitute.datacube.raw</textarea>
    <div>args:</div>
    <textarea id="args" cols="80">[]</textarea>
    <div>kwargs:</div>
    <textarea id="kwargs" cols="80" rows="15">
{
    "cube": "cell_types",
    "select": [{"start": 0, "stop": 150}, {"start": 0, "stop": 1000}]
}
    </textarea>
</form>
<div><button onclick='send();'>send</button></div>
<p><textarea id="log" style="background-color: #faa; width: 80%;" rows="20" disabled></textarea></div></p>
<script type="text/javascript" src="./autobahn.min.js"></script>
<script type="text/javascript">
        var ellog = null;
        ellog = document.getElementById('log');

        var connection = new autobahn.Connection({
             url: 'ws://devdatacube:8080/ws',
             realm: 'datacube'
        });

        var session;
        connection.onopen = function (s) {
            session = s;
        };

        connection.open();

        function log(m) {
            if(m.length > 5000) {
                m = m.substr(0, 5000) + " ... (truncated)";
            }
            ellog.innerHTML += m + '\n';
            ellog.scrollTop = ellog.scrollHeight;
        };

        function send() {
            call = document.getElementById('call').value;
            args = JSON.parse(document.getElementById('args').value);
            kwargs = JSON.parse(document.getElementById('kwargs').value);
            session.call(call, args, kwargs).then(
                function (res) {
                    log("Result:" + JSON.stringify(res));
                    if(res.data) {
                        float_data = window.atob(res.data);
                        draw(res.shape[1], res.shape[0], float_data);
                    }
                }
            );
        }

        function draw(width, height, float_data) {
            /*
            header = new DataView(data, 0, 4 * 3);
            response_code = header.getInt32(0, false);
            log("Response code: " + response_code);
            height = header.getInt32(4, false);
            width = header.getInt32(8, false);
            float_data = new Float32Array(data, 4 * 3);
            */

            var canvas = document.getElementById('graph');
            canvas.width = width;
            canvas.height = height;

            var context = canvas.getContext("2d");
            var imageData = context.createImageData(width, height);

            for (var i = 0; i < float_data.length; ++i) {
                var scaled = Math.round(Math.min(Math.max((float_data[i] + 2.0) / 4.0 * 255.0, 0.0), 255.0))
                imageData.data[i * 4] = Math.min(255, scaled * -2 + 256);
                imageData.data[i * 4 + 1] = Math.max(0, scaled * 2 - 256);
                imageData.data[i * 4 + 2] = 0;
                imageData.data[i * 4 + 3] = 255;
            }
            context.putImageData(imageData, 0, 0);
        }
</script>
</body>
</html>
