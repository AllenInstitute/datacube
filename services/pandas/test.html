<!DOCTYPE html>
<html>
<head>
</head>
<body>
<h3>pandas service test page</h3>
<noscript>You must enable JavaScript</noscript>
<form>
    <div>call:</div>
    <textarea id="call" cols="80">"org.alleninstitute.pandas_service.filter_cell_specimens"</textarea>
    <div>args:</div>
    <textarea id="args" cols="80">[]</textarea>
    <div>kwargs:</div>
    <textarea id="kwargs" style="width: 80%;" rows="15">
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// get N random records
var N = 100;
var indexes = [];
for(i = 0; i < N; ++i) {
    indexes.push(getRandomInt(0, 180000));
}
JSON.parse(`
    {
        "indexes": ${JSON.stringify(indexes)}
    }
`);


// get all indexes for a set of filters
/*
JSON.parse(`
    {
        "fields": "indexes_only",
        "start": 0,
        "stop": null,
        "filters": [
            {
                "field": "p_sg",
                "op": "<=",
                "value": 0.01
            },
            {
                "field": "pref_phase_sg",
                "op": "=",
                "value": 0.25
            },
            {
                "field": "pref_sf_sg",
                "op": "=",
                "value": 0.02
            },
            {
                "field": "p_dg",
                "op": "<=",
                "value": 0.01
            },
            {
                "field": "pref_tf_dg",
                "op": "=",
                "value": 1
            },
            {
                "field": "dsi_dg",
                "op": "between",
                "value": [
                    0.7,
                    2
                ]
            },
            {
                "field": "time_to_peak_ns",
                "op": "between",
                "value": [
                    0,
                    0.18
                ]
            },
            {
                "field": "area",
                "op": "in",
                "value": [
                    "VISp",
                    "VISal",
                    "VISl"
                ]
            }
        ]
    }
`);
*/
</textarea>
</form>
<div><button onclick="send()">send</button></div>
<p>Elapsed time: <span id="elapsed"></span>, Message size: <span id="msg_size"></span></p>
<p><textarea id="log" style="background-color: #faa; width: 80%;" rows="20" disabled></textarea></p>
<hr />
<h4>load test</h4>
<p>Execute the above query N times from M different websocket connections (be aware of browser websocket connection limits). Does not close websocket connections-- reload to free up old connections.</p>
<p>N: <input id="num_repeats" value="1" />, M: <input id="num_connections" value="1" /></p>
<p>Succeeded: <span id="succeeded">0</span>, Failed: <span id="failed">0</span>, Total: <span id="total">0</span></p>
<button onclick='load_test();'>execute</button>
<p><textarea id="load_test_log" style="width: 80%;" rows="20" disabled></textarea></p>
<script type="text/javascript" src="node_modules/autobahn-js-built/autobahn.min.js"></script>
<script type="text/javascript" src="node_modules/pako/dist/pako.min.js"></script>
<script type="text/javascript" src="node_modules/text-encoding/lib/encoding.js"></script>
<script type="text/javascript" src="./structured_array.js"></script>
<script type="text/javascript">
        var ellog = null;
        ellog = document.getElementById('log');

        var connection = new autobahn.Connection({
             url: 'ws://' + window.location.hostname + ':8081/ws',
             realm: 'pandas_service'
        });

        var session;
        connection.onopen = function (s) {
            session = s;
        };

        connection.open();

        function log(m) {
            if(m.length > 5000) {
                m = m.substr(0, 5000) + " ... (truncated)";
            }
            ellog.innerHTML += m + '\n';
            ellog.scrollTop = ellog.scrollHeight;
        };

        function send() {
            call = eval(document.getElementById('call').value);
            args = eval(document.getElementById('args').value);
            kwargs = eval(document.getElementById('kwargs').value);

            var start_time = new Date()
            session.call(call, args, kwargs).then(
                function (res) {
                    //document.getElementById('msg_size').innerHTML = res.length;
                    document.getElementById('msg_size').innerHTML = res.data.length;
                    if(kwargs.fields == "indexes_only") {
                        var end_time = new Date();
                        document.getElementById('elapsed').innerHTML = (end_time - start_time) + 'ms';
                        log("Result:" + JSON.stringify(res));
                    } else {
                        //var zbuf = atob(res.data);
                        var zbuf = res.data;
                        var buf = pako.inflate(zbuf);
                        res.data = buf;
                        var sa = new StructuredArray(res);
                        var records = sa.get_all();
                        var end_time = new Date();
                        document.getElementById('elapsed').innerHTML = (end_time - start_time) + 'ms';
                        log("Result:" + JSON.stringify(records));
                        //log("Result:" + JSON.stringify(res));
                    }
                },
                function (err) {
                    log("Error:" + JSON.stringify(err));
                }
            );
        };


        function load_test() {
            document.getElementById('load_test_log').innerHTML = '';
            var num_repeats = parseInt(document.getElementById('num_repeats').value);
            var num_connections = parseInt(document.getElementById('num_connections').value);

            var success_count = 0;
            var error_count = 0;

            connections = [];
            for(var i = 0; i < num_connections; ++i) {
                var c = new autobahn.Connection({
                     url: 'ws://' + window.location.hostname + ':8081/ws',
                     realm: 'pandas_service'
                });

                c.onopen = function(s) {
                    for(var j = 0; j < num_repeats; ++j) {
                        var start_time = new Date()
                        call = eval(document.getElementById('call').value);
                        args = eval(document.getElementById('args').value);
                        kwargs = eval(document.getElementById('kwargs').value);

                        s.call(call, args, kwargs).then(
                            function (res) {
                                decode_structured_array(res, function(records) {
                                    var end_time = new Date();
                                    document.getElementById('load_test_log').innerHTML += (end_time - start_time) + 'ms' + '\n';
                                    success_count += 1;
                                    document.getElementById('succeeded').innerHTML = success_count;
                                    document.getElementById('total').innerHTML = success_count + error_count;
                                });
                            },
                            function (err) {
                                document.getElementById('load_test_log').innerHTML += "Error:" + JSON.stringify(err) + '\n';
                                error_count += 1;
                                document.getElementById('failed').innerHTML = error_count;
                                document.getElementById('total').innerHTML = success_count + error_count;
                            }
                        );
                    }
                };

                connections.push(c);
            }
            for(var i = 0; i < num_connections; ++i) {
                connections[i].open();
            }
        };
</script>
</body>
</html>
