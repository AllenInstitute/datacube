<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>
<body bgcolor="gray">
<h3>datacube reference space test page</h3>
<noscript>You must enable JavaScript</noscript>
<p>slice:<div id="slider"></div></p>
<p>opacity:<div id="opacity"></div></p>
<p>MNI coords: <span id="coords"></span></p>
<canvas id="graph"  width="300" height="150"></canvas>
<script type="text/javascript" src="node_modules/autobahn-js-built/autobahn.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script type="text/javascript">
    $(function() {
        var pending = false;
        var did_scroll = false;
        function scroll() {
            did_scroll = true;
        }
        setInterval(function() {
            if(did_scroll) {
                if(!pending) {
                    did_scroll = false;
                    pending = true;
                    send($('#slider').slider("option", "value"));
                }
            }
        }, 50);

        $('#slider').slider(
            {
                min: 0,
                max: 377,
                value: 194,
                slide: function(event, ui) {
                    scroll();
                }
            }
        );
        $('#opacity').slider(
            {
                min: 0,
                max: 100,
                value: 25,
                slide: function(event, ui) {
                    render();
                }
            }
        );

        var connection = new autobahn.Connection({
             url: 'ws://' + window.location.hostname + (window.location.port ? ':' + window.location.port : '') + '/ws',
             realm: 'aibs'
        });

        var session;
        connection.onopen = function (s) {
            session = s;
            scroll();
        };

        connection.open();

        var canvas = document.getElementById('graph');
        canvas.addEventListener('click', function(event) {
            var rect = canvas.getBoundingClientRect();
            var x = Math.round(event.clientX - rect.left);
            var y = Math.round(event.clientY - rect.top);
            
            var idx = Math.round($('#slider').slider("option", "value"));
            var select = {'left_right': [y], 'anterior_posterior': [x], 'superior_inferior': [idx]};
            var call = 'org.brain-map.api.datacube.raw.mni';
            var args = [];
            var kwargs = {'fields': ['mni_left_right', 'mni_anterior_posterior', 'mni_superior_inferior'], 'select': select};
            session.call(call, args, kwargs).then(
                function (res) {
                    var mni_left_right = res.coords.mni_left_right.data[0];
                    var mni_anterior_posterior = res.coords.mni_anterior_posterior.data[0];
                    var mni_superior_inferior = res.coords.mni_superior_inferior.data[0];
                    document.getElementById('coords').innerHTML = JSON.stringify([mni_left_right, mni_anterior_posterior, mni_superior_inferior]);
                }
            );
        });

        var image = document.createElement('img');
        image.style.display = 'none';
        var overlay = document.createElement('img');
        overlay.style.display = 'none';
        var got_image = false;
        var got_overlay = false;

        function render() {
            var canvas = document.getElementById('graph');
            canvas.width = image.width;
            canvas.height = image.height;

            var context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(image, 0, 0, canvas.width, canvas.height);
            context.globalCompositeOperation = 'source-over';
            context.globalAlpha = $('#opacity').slider("option", "value")/100.0;
            context.drawImage(overlay, 0, 0, canvas.width, canvas.height);
            // if a file or dataUrl is needed
            //canvas.toBlob(function(blob) { console.log(blob); }, 'image/jpeg', 0.4);
            //console.log(canvas.toDataURL('image/jpeg', 0.4));
        };

        function send(idx) {
            select = {'left_right': null, 'anterior_posterior': null, 'superior_inferior': idx};
            select_color = {'left_right': null, 'anterior_posterior': null, 'superior_inferior': idx, 'RGBA': null};
            var start = new Date();
            got_image = false;
            got_overlay = false;

            function finish() {
                if(pending && got_image && got_overlay) {
                    render();
                    pending = false;
                    console.log('finished in ' + (new Date() - start) + ' ms');
                }
            }

            var call = 'org.brain-map.api.datacube.image.mni';
            var args = [];
            var kwargs = {'field': 'mni', 'image_format': 'jpeg', 'select': select, 'dim_order': ['anterior_posterior', 'left_right']};
            session.call(call, args, kwargs).then(
                function (res) {
                    if(res.data) {
                        image.onload = function() {
                            console.log('mni jpeg: ' + res.data.length + ' bytes');
                            got_image = true;
                            finish();
                        };
                        image.src = res.data;
                    }
                }
            );

            call = 'org.brain-map.api.datacube.image.mni';
            args = [];
            kwargs = {'field': 'color', 'image_format': 'png', 'select': select_color, 'dim_order': ['anterior_posterior', 'left_right']};
            session.call(call, args, kwargs).then(
                function (res) {
                    if(res.data) {
                        overlay.onload = function() {
                            console.log('annotation png: ' + res.data.length + ' bytes');
                            got_overlay = true;
                            finish();
                        };
                        overlay.src = res.data;
                    }
                }
            );
        }
    });
</script>
</body>
</html>
