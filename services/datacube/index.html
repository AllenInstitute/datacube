<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>
<body bgcolor="gray">
<h3>datacube reference space test page</h3>
<noscript>You must enable JavaScript</noscript>
<p>slice:<div id="slider"></div></p>
<p>opacity:<div id="opacity"></div></p>
<canvas id="graph"  width="300" height="150"></canvas>
<script type="text/javascript" src="node_modules/autobahn-js-built/autobahn.min.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script type="text/javascript">
        var pending = false;
        var did_scroll = false;
        function scroll() {
            did_scroll = true;
        }
        setInterval(function() {
            if(did_scroll) {
                if(!pending) {
                    did_scroll = false;
                    pending = true;
                    send($('#slider').slider("option", "value"));
                }
            }
        }, 50);

        $(function() {
            $('#slider').slider(
                {
                    min: 0,
                    max: 319,
                    value: 160,
                    slide: function(event, ui) {
                        scroll();
                    }
                }
            );
            $('#opacity').slider(
                {
                    min: 0,
                    max: 100,
                    value: 25,
                    slide: function(event, ui) {
                        render();
                    }
                }
            );
        });

        var connection = new autobahn.Connection({
             url: 'ws://' + window.location.hostname + (window.location.port ? ':' + window.location.port : '') + '/ws',
             realm: 'aibs'
        });

        var session;
        connection.onopen = function (s) {
            session = s;
            scroll();
        };

        connection.open();

        var image = null; 
        var overlay = null;
        var got_image = false;
        var got_overlay = false;

        function render() {
            var canvas = document.getElementById('graph');
            canvas.width = image.width;
            canvas.height = image.height;

            var canvas = document.getElementById('graph');
            var context = canvas.getContext('2d');
            var alpha = document.getElementById('alpha');
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(overlay, 0, 0, canvas.width, canvas.height);
            context.globalCompositeOperation = 'source-atop';
            context.globalAlpha = 1.0 - $('#opacity').slider("option", "value")/100.0;
            context.drawImage(image, 0, 0, canvas.width, canvas.height);

            // if a file or dataUrl is needed
            //canvas.toBlob(function(blob) { console.log(blob); }, 'image/jpeg', 0.4);
            //console.log(canvas.toDataURL('image/jpeg', 0.4));
        };

        function send(idx) {
            select = [null,[idx],null];
            var start = new Date();
            got_image = false;
            got_overlay = false;

            function finish() {
                if(pending && got_image && got_overlay) {
                    render();
                    pending = false;
                    console.log('finished in ' + (new Date() - start) + ' ms');
                }
            }

            var call = 'org.alleninstitute.datacube.image';
            var args = [];
            var kwargs = {'cube': 'ccf', 'image_format': 'jpeg', 'select': select};
            session.call(call, args, kwargs).then(
                function (res) {
                    if(res.data) {
                        image = document.createElement('img');
                        image.style.display = 'none';
                        image.src = res.data;
                        console.log('ccf jpeg: ' + res.data.length + ' bytes');
                        got_image = true;
                        finish();
                    }
                }
            );

            call = 'org.alleninstitute.datacube.image';
            args = [];
            kwargs = {'cube': 'ccf_anno_color', 'image_format': 'png', 'select': select.concat([null])};
            session.call(call, args, kwargs).then(
                function (res) {
                    if(res.data) {
                        overlay = document.createElement('img');
                        overlay.style.dispaly = 'none';
                        overlay.src = res.data;
                        console.log('annotation png: ' + res.data.length + ' bytes');
                        got_overlay = true;
                        finish();
                    }
                }
            );

        }
</script>
</body>
</html>
