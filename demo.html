<!DOCTYPE html>
<html>
<head>
</head>
<body>
<h3>pandas service demo page</h3>
<noscript>You must enable JavaScript</noscript>
<form>
    <div>filters:</div>
    <textarea id="filters" style="width: 80%;" rows="15">
[
    {
        "field": "p_sg",
        "op": "<=",
        "value": 0.01
    },
    {
        "field": "pref_phase_sg",
        "op": "=",
        "value": 0.25
    },
    {
        "field": "pref_sf_sg",
        "op": "=",
        "value": 0.02
    },
    {
        "field": "p_dg",
        "op": "<=",
        "value": 0.01
    },
    {
        "field": "pref_tf_dg",
        "op": "=",
        "value": 1
    },
    {
        "field": "dsi_dg",
        "op": "between",
        "value": [
            0.7,
            2
        ]
    },
    {
        "field": "time_to_peak_ns",
        "op": "between",
        "value": [
            0,
            0.18
        ]
    },
    {
        "field": "area",
        "op": "in",
        "value": [
            "VISp",
            "VISal",
            "VISl"
        ]
    }
]
</textarea>
</form>
<div><button onclick="apply_filters()">apply filters</button></div>
<p>Results: <span id="num_rows"></span></p>
<table style="width:87%;">
<tr>
<td>
<textarea id="records" style="width:98%;" rows="20" wrap="off" disabled></textarea>
</td>
<td>
<div id="scrollbar" style="overflow:scroll;overflow:auto;height:20em;width:12px;" onscroll="scroll()">
<textarea id="scroller" rows="20" cols="1" disabled></textarea>
</div>
</td>
</tr>
</table>
<script type="text/javascript" src="./autobahn.min.js"></script>
<script type="text/javascript" src="./zlib.min.js"></script>
<script type="text/javascript" src="./pako.min.js"></script>
<script type="text/javascript" src="./encoding.js"></script>
<script type="text/javascript" src="./structured_array.js"></script>
<script type="text/javascript">

        function BrainObservatoryPandasService(url, realm, get_current_filters, apply_filters_callback, get_current_page_range, page_data_callback) {
            this.connection = new autobahn.Connection({
                 url: url,
                 realm: realm
            });

            service = this;
            this.connection.onopen = function (s) {
                service.session = s;
                service.apply_filters();
            };

            this.get_current_filters = get_current_filters;
            this.apply_filters_callback = apply_filters_callback;
            this.get_current_page_range = get_current_page_range
            this.page_data_callback = page_data_callback;

            this.connection.open();
        };

        BrainObservatoryPandasService.prototype.apply_filters = function() {
            filters = this.get_current_filters();
            var service = this;
            this.session.call('org.alleninstitute.pandas_service.filter_cell_specimens', [],
                              {'fields': 'indexes_only', 'filters': filters}).then(
                function (res) {
                    service.indexes = res;
                    service.apply_filters_callback(service.indexes.length);
                    service.update_page();
                }
            );
                    
        };

        BrainObservatoryPandasService.prototype.update_page = function() {
            var page_range = this.get_current_page_range(this.indexes.length);
            var indexes = this.indexes.slice(page_range[0], page_range[1]);
            var service = this;
            this.session.call('org.alleninstitute.pandas_service.filter_cell_specimens', [],
                              {'indexes': indexes}).then(
                function (res) {
                    var sa = new StructuredArray(res);
                    var records = sa.get_all();
                    service.page_data_callback(records);
                }
            );
        }

        function get_current_filters() {
            return JSON.parse(document.getElementById('filters').value);
        };

        function get_current_page_range(sz) {
            var scrollbar = document.getElementById('scrollbar');
            var start_idx = Math.round(scrollbar.scrollTop/scrollbar.scrollHeight * sz);
            var end_idx = start_idx + 20;
            return [start_idx, end_idx]
        };

        function process_num_results(sz) {
            document.getElementById.scrollTop = 0; // reset scroll
            document.getElementById('num_rows').innerHTML = sz;
            document.getElementById('scroller').rows = sz;
        };

        function process_page(records) {
            var txt = [];
            for(var i = 0; i < records.length; ++i) {
                txt.push(JSON.stringify(records[i]));
            }
            document.getElementById('records').innerHTML = txt.join('\n');
        };

        var service = new BrainObservatoryPandasService('ws://' + window.location.hostname + ':8081/ws',
                                                        'pandas_service',
                                                        get_current_filters,
                                                        process_num_results,
                                                        get_current_page_range,
                                                        process_page);


        function apply_filters() {
            service.apply_filters();
        };


        // poll for scroll events every 250ms instead of acting on every single scroll event
        var did_scroll = false;
        function scroll() {
            did_scroll = true;
        }
        setInterval(function() {
            if(did_scroll) {
                did_scroll = false;
                update_page();
            }
        }, 250);

        function update_page() {
            service.update_page();
        };

</script>
</body>
</html>
